# talk_system ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ä½œæˆæ—¥**: 2025-12-27
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v0.2.0-alpha
**å¯¾è±¡**: talk_system (Raspberry Pi å¸¸é§å‹å¯¾è©±ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ)

---

## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

talk_systemã¯ã€Raspberry Piä¸Šã§å‹•ä½œã™ã‚‹éŸ³å£°å¯¾è©±ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚
ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰ã€Œã‚­ã‚«ã‚¤ãã‚“ã€ã§èµ·å‹•ã—ã€OpenAI Realtime APIã‚’ä½¿ç”¨ã—ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°å¯¾è©±ã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     wake_word_daemon.py                      â”‚
â”‚              (ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¸¸é§ãƒ—ãƒ­ã‚»ã‚¹)                     â”‚
â”‚         Porcupine Wakewordã‚’ç›£è¦– â†’ æ¤œçŸ¥æ™‚ã«GUIèµ·å‹•           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    conversation_app.py                       â”‚
â”‚                    (ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Audio     â”‚   Realtime   â”‚     GUI     â”‚  WakeWord  â”‚  â”‚
â”‚  â”‚   Handler   â”‚    Client    â”‚   Handler   â”‚   Engine   â”‚  â”‚
â”‚  â”‚  (Thread)   â”‚ (asyncio WS) â”‚  (pygame)   â”‚  (Thread)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ ä¸¦è¡Œå‡¦ç†ãƒ¢ãƒ‡ãƒ«

talk_systemã¯ã€**asyncio + Thread** ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ‡ãƒ«ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè¡Œå½¢æ…‹ã¨ç†ç”±ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

### ä¸¦è¡Œå‡¦ç†ã®è²¬å‹™åˆ†é›¢

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ                 | å®Ÿè¡Œå½¢æ…‹         | ç†ç”±                                      |
| ------------------------ | ------------ | --------------------------------------- |
| éŸ³å£°å…¥åŠ› (AudioHandler)    | **Thread**   | PyAudioã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°I/Oï¼‰             |
| éŸ³å£°å‡ºåŠ› (AudioHandler)    | **Thread**   | PyAudioå†ç”Ÿï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°I/Oï¼‰                  |
| Realtime WebSocket       | **asyncio**  | éåŒæœŸI/Oã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã¨è¦ªå’Œæ€§é«˜ã„                  |
| GUI / pygame             | **ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰**  | pygameã¯ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã®ã¿å‹•ä½œå¯èƒ½                 |
| ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰        | **Thread**   | Porcupineå‡¦ç†ï¼ˆCPUé›†ç´„ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ï¼‰   |
| WakeWordDaemon (ã‚°ãƒ­ãƒ¼ãƒãƒ«) | **ç‹¬ç«‹ãƒ—ãƒ­ã‚»ã‚¹**   | ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¸¸é§ã€conversation_appèµ·å‹•ã®ãƒˆãƒªã‚¬ãƒ¼ |

### ä¸¦è¡Œå‡¦ç†ãƒ«ãƒ¼ãƒ«

1. **éŸ³å£°I/O**: PyAudioã¯åŒæœŸçš„ãªãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°I/Oã®ãŸã‚ã€å°‚ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
2. **WebSocket**: asyncioã®éåŒæœŸI/Oã‚’æ´»ç”¨ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã§åŠ¹ç‡çš„ã«å‡¦ç†
3. **GUI**: pygameã®åˆ¶ç´„ã«ã‚ˆã‚Šã€ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œå¿…é ˆ
4. **CPUé›†ç´„ã‚¿ã‚¹ã‚¯**: Porcupineå‡¦ç†ãªã©ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†å°‚ç”¨ã‚¹ãƒ¬ãƒƒãƒ‰

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. éŸ³å£°å…¥åŠ›ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Thread   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   asyncio   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒã‚¤ã‚¯   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ AudioHandler â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  asyncio     â”‚
â”‚ (48kHz) â”‚            â”‚ (ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°) â”‚            â”‚  Queue       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  48k â†’ 24k   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                                          â–¼
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚ RealtimeClientâ”‚
                                                  â”‚  (WebSocket) â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—:**

1. PyAudioãŒãƒã‚¤ã‚¯ã‹ã‚‰48kHz PCM16ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚Šï¼ˆThreadï¼‰
2. `AudioHandler.record_loop()` ãŒ audioop.ratecv ã§ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆ48kHz â†’ 24kHzï¼‰
3. `audio_input_callback()` ã‚’çµŒç”±ã—ã¦ `RealtimeClient.send_audio()` ã«é€ä¿¡ï¼ˆasyncioï¼‰
4. Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¾Œã€WebSocketã§ OpenAI Realtime API ã«é€ä¿¡

### 2. éŸ³å£°å‡ºåŠ›ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   Thread   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RealtimeClientâ”‚ â”€â”€â”€â”€â”€â”€> â”‚  asyncio     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  Audio   â”‚
â”‚  (WebSocket) â”‚          â”‚  Queue       â”‚            â”‚ Handler  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                           â”‚
                                                           â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚ ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼     â”‚
                                                    â”‚  (48kHz)    â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—:**

1. WebSocketã‹ã‚‰éŸ³å£°ãƒ‡ãƒ«ã‚¿ï¼ˆBase64, 24kHz PCM16ï¼‰ã‚’å—ä¿¡ï¼ˆasyncioï¼‰
2. Base64ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã€`audio_queue` (asyncio.Queue) ã«è¿½åŠ 
3. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã§ `audio_queue.get()` ã—ã¦ãƒãƒ£ãƒ³ã‚¯ã‚’å–å¾—
4. `run_in_executor()` ã§ `AudioHandler.play_audio()` ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
5. AudioHandlerå†…ã§ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆ24kHz â†’ 48kHzï¼‰ï¼‹ã‚¹ãƒ†ãƒ¬ã‚ªå¤‰æ›
6. PyAudioã§å†ç”Ÿ

### 3. ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RealtimeClientâ”‚ (WebSocket receive_loop)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ response.audio.delta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> audio_queue
       â”œâ”€ input_audio_buffer.speech_started â”€> on_user_speech_start()
       â”œâ”€ response.created â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> on_response_created()
       â”œâ”€ response.done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> on_response_done()
       â”œâ”€ response.audio_transcript.done â”€â”€â”€â”€> handle_agent_transcript()
       â””â”€ conversation.item.input_audio_transcription.completed
                                            â””> handle_user_transcript()
```

---

## ğŸ”„ çŠ¶æ…‹ç®¡ç†

### çŠ¶æ…‹å®šç¾©ï¼ˆPhase 1.1+ï¼‰

```python
class AppState(Enum):
    IDLE = auto()        # å¾…æ©Ÿä¸­ï¼ˆã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰å¾…ã¡ï¼‰
    LISTENING = auto()   # èã„ã¦ã„ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼éŸ³å£°å—ä»˜ä¸­ï¼‰
    PROCESSING = auto()  # è€ƒãˆä¸­ï¼ˆAIå¿œç­”ç”Ÿæˆä¸­ï¼‰
    SPEAKING = auto()    # ç™ºè©±ä¸­ï¼ˆéŸ³å£°å‡ºåŠ›ä¸­ï¼‰
    ERROR = auto()       # ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ï¼ˆå¾©æ—§å‡¦ç†ä¸­ï¼‰
```

### çŠ¶æ…‹é·ç§»å›³

```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  IDLE   â”‚ (wake_word_daemonå¾…æ©Ÿ)
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â”‚ wake word detected
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”Œâ”€â”€â”€>â”‚LISTENINGâ”‚<â”€â”€â”€â”€â”€â”€â”
     â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
     â”‚         â”‚ user speechâ”‚ playback done
     â”‚         â–¼            â”‚
     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚    â”‚PROCESSINGâ”‚       â”‚
     â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
     â”‚         â”‚ AI responseâ”‚
     â”‚         â–¼            â”‚
     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â””â”€â”€â”€â”€â”‚SPEAKING â”‚â”€â”€â”€â”€â”€â”€â”€â”˜
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ error
               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ERROR  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¨±å¯ã•ã‚Œã‚‹çŠ¶æ…‹é·ç§»

```python
ALLOWED_TRANSITIONS = {
    AppState.IDLE:       {AppState.LISTENING, AppState.ERROR},
    AppState.LISTENING:  {AppState.PROCESSING, AppState.ERROR},
    AppState.PROCESSING: {AppState.SPEAKING, AppState.ERROR},
    AppState.SPEAKING:   {AppState.LISTENING, AppState.PROCESSING, AppState.ERROR},
    AppState.ERROR:      {AppState.IDLE, AppState.LISTENING}
}
```

ä¸æ­£ãªé·ç§»ï¼ˆä¾‹: IDLE â†’ SPEAKINGï¼‰ã¯ `StateTransition.is_valid_transition()` ã§æ¤œå‡ºã•ã‚Œã€è­¦å‘Šãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚

---

## ğŸ­ å‰²ã‚Šè¾¼ã¿å‡¦ç†ï¼ˆBarge-inï¼‰

### å‰²ã‚Šè¾¼ã¿ãƒ•ãƒ­ãƒ¼

AIå¿œç­”ä¸­ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œãã‹ã„ãã‚“ã€ã¨ç™ºè©±ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI SPEAKING çŠ¶æ…‹                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ãƒ­ãƒ¼ã‚«ãƒ«       â”‚  wake word detected                     â”‚
â”‚  â”‚ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
â”‚  â”‚æ¤œçŸ¥ï¼ˆThreadï¼‰ â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚execute_interrupt()â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼             â–¼             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ interrupt â”‚  â”‚ audio_queue â”‚  â”‚ API cancel â”‚
        â”‚  active   â”‚  â”‚   clear     â”‚  â”‚  request   â”‚
        â”‚   = True  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ set_state()  â”‚
        â”‚ PROCESSING   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…è©³ç´°:**

1. **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥**: AIå¿œç­”ä¸­ï¼ˆ`local_interrupt_enabled=True`ï¼‰ã®ã¿æœ‰åŠ¹
2. **éŸ³å£°ã‚­ãƒ¥ãƒ¼ã®ã‚¯ãƒªã‚¢**: æœªå†ç”Ÿã®éŸ³å£°ãƒãƒ£ãƒ³ã‚¯ã‚’ç ´æ£„
3. **å†ç”Ÿåœæ­¢**: `AudioHandler.stop_playback()` ã§ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
4. **APIã‚­ãƒ£ãƒ³ã‚»ãƒ«**: `response.cancel` ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
5. **å‰²ã‚Šè¾¼ã¿ãƒ•ãƒ©ã‚°**: `interrupt_active=True` ã§æ–°ã—ã„éŸ³å£°ãƒãƒ£ãƒ³ã‚¯ã‚’æ‹’å¦
6. **Turn Detectionå†æœ‰åŠ¹åŒ–**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¬¡ã®ç™ºè©±ã‚’å—ã‘ä»˜ã‘ã‚‹

---

## ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆPhase 1.3+ï¼‰

### å¾©æ—§æˆ¦ç•¥

| ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—          | æ¤œå‡ºæ–¹æ³•                  | å¾©æ—§æˆ¦ç•¥                          |
| --------------- | --------------------- | ----------------------------- |
| ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒã‚¤ã‚¹åˆæœŸåŒ–å¤±æ•—  | OSError in start_stream | ãƒ‡ãƒã‚¤ã‚¹è¨ºæ–­ãƒ­ã‚°å‡ºåŠ› â†’ AppState.ERROR    |
| WebSocketæ¥ç¶šå¤±æ•—    | Exception in connect  | è‡ªå‹•å†æ¥ç¶šï¼ˆæœ€å¤§3å›ã€2ç§’é–“éš”ï¼‰             |
| WebSocketåˆ‡æ–­      | ConnectionClosed      | ãƒ­ã‚°è¨˜éŒ²ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—                  |
| ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ä¾‹å¤–        | Exception in run()    | ãƒ­ã‚°è¨˜éŒ² â†’ finally ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—       |
| éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼         | Exception in write()  | ãƒ­ã‚°è¨˜éŒ²ã€æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ç¶™ç¶š               |

### è‡ªå‹•å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯

```python
for attempt in range(1, max_reconnect_attempts + 1):
    try:
        await self._connect_internal()
        logger.info(f"Connected (attempt {attempt}/{max_reconnect_attempts})")
        return
    except Exception as e:
        logger.error(f"Connection attempt {attempt} failed: {e}")
        if attempt < max_reconnect_attempts:
            await asyncio.sleep(reconnect_delay)
        else:
            raise RuntimeError("Failed after max attempts")
```

### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¿è¨¼

```python
try:
    # ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
    while self.gui.running:
        ...
except Exception as e:
    logger.error("Error in main loop", exc_info=True)
    self.set_state(AppState.ERROR)
finally:
    # å¿…ãšã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Ÿè¡Œã•ã‚Œã‚‹
    await self.cleanup()
```

---

## ğŸ“¦ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
talk_system/
â”œâ”€â”€ conversation_app.py         # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
â”œâ”€â”€ wake_word_daemon.py         # ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰å¸¸é§ãƒ‡ãƒ¼ãƒ¢ãƒ³
â”œâ”€â”€ config.py                   # è¨­å®šï¼ˆå¾Œæ–¹äº’æ›æ€§ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ state_machine.py        # çŠ¶æ…‹ç®¡ç†ï¼ˆPhase 1.1+ï¼‰
â”‚   â”œâ”€â”€ logging_config.py       # ãƒ­ã‚®ãƒ³ã‚°è¨­å®šï¼ˆPhase 1.2+ï¼‰
â”‚   â”œâ”€â”€ config_models.py        # å‹å®‰å…¨ãªè¨­å®šï¼ˆPhase 2.1+ï¼‰
â”‚   â”œâ”€â”€ audio.py                # éŸ³å£°å…¥å‡ºåŠ›
â”‚   â”œâ”€â”€ realtime_client.py      # OpenAI Realtime API WebSocketã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ gui.py                  # GUIç®¡ç†
â”‚   â”œâ”€â”€ wake_word.py            # ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”œâ”€â”€ animation/              # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ animation_controller.py
â”‚   â”‚   â”œâ”€â”€ character_renderer.py
â”‚   â”‚   â”œâ”€â”€ eye_animator.py
â”‚   â”‚   â”œâ”€â”€ mouth_animator.py
â”‚   â”‚   â”œâ”€â”€ hand_animator.py
â”‚   â”‚   â””â”€â”€ body_animator.py
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ search_utils.py     # Tavilyæ¤œç´¢ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ assets/                     # ç”»åƒãƒ»éŸ³å£°ãƒªã‚½ãƒ¼ã‚¹
â”œâ”€â”€ model/                      # ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰ãƒ¢ãƒ‡ãƒ«
â”œâ”€â”€ logs/                       # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ—¥æ¬¡ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
â””â”€â”€ docs/
    â”œâ”€â”€ ARCHITECTURE.md         # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
    â”œâ”€â”€ REFACTORING_PLAN.md     # ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»
    â”œâ”€â”€ TASK_TRACKER.md         # ã‚¿ã‚¹ã‚¯ç®¡ç†
    â””â”€â”€ QUICKSTART_REFACTORING.md
```

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è²¬å‹™

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«                | è²¬å‹™                                 |
| -------------------- | ---------------------------------- |
| conversation_app.py  | å…¨ä½“ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€çŠ¶æ…‹ç®¡ç†ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†       |
| src/audio.py         | PyAudioãƒ©ãƒƒãƒ‘ãƒ¼ã€ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã€ãƒ‡ãƒã‚¤ã‚¹ç®¡ç†        |
| src/realtime_client  | WebSocketé€šä¿¡ã€ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã€è‡ªå‹•å†æ¥ç¶š          |
| src/gui.py           | pygame UIã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆ       |
| src/wake_word.py     | Porcupineãƒ©ãƒƒãƒ‘ãƒ¼ã€ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥            |
| src/animation/*      | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¾ï¼ˆç›®/å£/æ‰‹/èƒ´ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ï¼‰          |
| src/state_machine.py | çŠ¶æ…‹å®šç¾©ã€é·ç§»æ¤œè¨¼                          |
| src/logging_config   | çµ±ä¸€ãƒ­ã‚®ãƒ³ã‚°è¨­å®š                           |
| src/config_models    | å‹å®‰å…¨ãªè¨­å®šç®¡ç†ï¼ˆpydanticï¼‰                 |

---

## ğŸ”§ è¨­å®šç®¡ç†ï¼ˆPhase 2.1+ï¼‰

### æ–°ã—ã„å‹å®‰å…¨ãªè¨­å®šï¼ˆæ¨å¥¨ï¼‰

```python
from src.config_models import AppConfig

# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿
config = AppConfig()

# å‹ãƒ’ãƒ³ãƒˆè£œå®ŒãŒåŠ¹ã
print(config.audio.sample_rate)  # 24000
print(config.realtime.model)     # "gpt-4o-mini-realtime-preview"
```

### å¾Œæ–¹äº’æ›æ€§ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰

```python
from config import SAMPLE_RATE, OPENAI_API_KEY

# å¾“æ¥é€šã‚Šä½¿ç”¨å¯èƒ½
print(SAMPLE_RATE)  # 24000
```

### ç’°å¢ƒå¤‰æ•°ã®ãƒãƒƒãƒ”ãƒ³ã‚°

| ç’°å¢ƒå¤‰æ•°                          | è¨­å®šãƒ‘ã‚¹                                | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤                                   |
| ----------------------------- | ----------------------------------- | ---------------------------------------- |
| OPENAI_API_KEY                | config.openai_api_key               | ï¼ˆå¿…é ˆï¼‰                                     |
| INPUT_DEVICE_INDEX            | config.audio.input_device_index     | None                                     |
| REALTIME_MODEL                | config.realtime.model               | "gpt-4o-mini-realtime-preview"           |
| MODEL_FILE_PATH               | config.paths.model_file             | "model/kikaikun_ja_raspberry-pi_v4_0_0.ppn" |

---

## ğŸš€ èµ·å‹•ãƒ•ãƒ­ãƒ¼

### 1. ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•

```bash
# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’èµ·å‹•
python wake_word_daemon.py &
```

### 2. ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥

```
wake_word_daemon.py
  â†“ Porcupineã§ã€Œãã‹ã„ãã‚“ã€ã‚’æ¤œçŸ¥
  â†“ subprocess.Popen()
conversation_app.py èµ·å‹•
```

### 3. å¯¾è©±é–‹å§‹

```
conversation_app.py
  â”œâ”€ AudioåˆæœŸåŒ–
  â”œâ”€ Realtime APIæ¥ç¶š
  â”œâ”€ GUIèµ·å‹•ï¼ˆpygameï¼‰
  â””â”€ ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—é–‹å§‹
      â”œâ”€ GUIæ›´æ–°ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰
      â”œâ”€ éŸ³å£°å†ç”Ÿï¼ˆThreadï¼‰
      â”œâ”€ WebSocketå—ä¿¡ï¼ˆasyncioï¼‰
      â””â”€ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–
```

### 4. çµ‚äº†ãƒ•ãƒ­ãƒ¼

```
- 3åˆ†é–“ç„¡æ“ä½œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµ‚äº†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè©±ï¼ˆã€Œãƒã‚¤ãƒã‚¤ã€ç­‰ï¼‰
- Ctrl+C

  â†“
cleanup()
  â”œâ”€ WebSocket.close()
  â”œâ”€ AudioHandler.terminate()
  â”œâ”€ WakeWordEngine.delete()
  â””â”€ GUIHandler.quit()

  â†“
wake_word_daemon.py ã«æˆ»ã‚‹ï¼ˆå¾…æ©Ÿå†é–‹ï¼‰
```

---

## ğŸ“ ãƒ­ã‚°ç®¡ç†ï¼ˆPhase 1.2+ï¼‰

### ãƒ­ã‚°å‡ºåŠ›å…ˆ

- **ãƒ•ã‚¡ã‚¤ãƒ«**: `logs/talk_system.log`ï¼ˆæ—¥æ¬¡ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€7æ—¥åˆ†ä¿æŒï¼‰
- **ã‚³ãƒ³ã‚½ãƒ¼ãƒ«**: æ¨™æº–å‡ºåŠ›ï¼ˆåŒã˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰

### ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
2025-12-27 18:30:15 [INFO] conversation_app:144 - Conversation App Started
2025-12-27 18:30:16 [INFO] src.realtime_client:81 - Connected to OpenAI Realtime API
2025-12-27 18:30:20 [DEBUG] src.audio:198 - Starting audio record loop
```

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ä½¿ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

| ãƒ¬ãƒ™ãƒ«     | ç”¨é€”                          |
| ------- | --------------------------- |
| DEBUG   | è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆçŠ¶æ…‹é·ç§»ã€ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ï¼‰    |
| INFO    | é€šå¸¸å‹•ä½œã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ¥ç¶šã€é–‹å§‹ã€å®Œäº†ï¼‰       |
| WARNING | è­¦å‘Šï¼ˆä¸æ­£ãªçŠ¶æ…‹é·ç§»ã€éè‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼‰       |
| ERROR   | ã‚¨ãƒ©ãƒ¼ï¼ˆæ¥ç¶šå¤±æ•—ã€ãƒ‡ãƒã‚¤ã‚¹ã‚¨ãƒ©ãƒ¼ã€ä¾‹å¤–ï¼‰      |

---

## ğŸ” ãƒ‡ãƒãƒƒã‚°ã‚¬ã‚¤ãƒ‰

### ä¸€èˆ¬çš„ãªå•é¡Œã¨å¯¾å‡¦æ³•

#### éŸ³å£°ãŒå‡ºåŠ›ã•ã‚Œãªã„

1. **ãƒ‡ãƒã‚¤ã‚¹ç¢ºèª**:
   ```bash
   grep "Available audio devices" logs/talk_system.log
   ```

2. **ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š**:
   `.env` ã«æ­£ã—ã„ãƒ‡ãƒã‚¤ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
   ```env
   OUTPUT_DEVICE_INDEX=1
   ```

#### WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼

1. **APIã‚­ãƒ¼ç¢ºèª**:
   ```bash
   grep "OPENAI_API_KEY" .env
   ```

2. **å†æ¥ç¶šãƒ­ã‚°ç¢ºèª**:
   ```bash
   grep "Connection attempt" logs/talk_system.log
   ```

#### å‰²ã‚Šè¾¼ã¿ãŒåŠ¹ã‹ãªã„

1. **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¦ã‚§ã‚¤ã‚¯ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ã®çŠ¶æ…‹ç¢ºèª**:
   ```bash
   grep "local_interrupt_enabled" logs/talk_system.log
   ```

2. **Porcupineãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª**:
   ```bash
   ls -l model/kikaikun_ja_raspberry-pi_v4_0_0.ppn
   ```

---

## ğŸ”® å°†æ¥ã®æ‹¡å¼µ

### Phase 3ï¼ˆè¨ˆç”»ä¸­ï¼‰

- **å‰²ã‚Šè¾¼ã¿å‡¦ç†æ”¹å–„**: ã‚ˆã‚Šæ»‘ã‚‰ã‹ãªéŸ³å£°åœæ­¢ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯éŸ³
- **äººæ ¼åˆ‡æ›¿æ©Ÿèƒ½**: å­ä¾›å‘ã‘ãƒ¢ãƒ¼ãƒ‰ã€ç°¡æ½”ãƒ¢ãƒ¼ãƒ‰ç­‰

### Phase 4ï¼ˆè¨ˆç”»ä¸­ï¼‰

- **ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–**: `pip install talk-system`
- **systemdå¯¾å¿œ**: è‡ªå‹•èµ·å‹•ã€è‡ªå‹•å¾©æ—§

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [REFACTORING_PLAN.md](../REFACTORING_PLAN.md) - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»è©³ç´°
- [TASK_TRACKER.md](../TASK_TRACKER.md) - ã‚¿ã‚¹ã‚¯ç®¡ç†ãƒ»é€²æ—
- [QUICKSTART_REFACTORING.md](../QUICKSTART_REFACTORING.md) - å®Ÿè£…ã‚¬ã‚¤ãƒ‰

---

**Last Updated**: 2025-12-27
**Contributors**: Claude (via claude-code)
